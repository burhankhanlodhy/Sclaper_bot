<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot - Kraken Paper Trading Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <style>
        .sidebar { position: fixed; top: 0; left: 0; height: 100vh; width: 280px; background-color: #343a40; padding: 1rem; z-index: 1000; transition: transform 0.3s ease-in-out; }
        .sidebar-brand { color: #fff; font-size: 1.25rem; font-weight: 500; text-decoration: none; margin-bottom: 2rem; display: block; border-bottom: 1px solid #495057; padding-bottom: 1rem; }
        .sidebar-nav { list-style: none; padding: 0; margin: 0; }
        .sidebar-nav .nav-item { margin-bottom: 0.5rem; }
        .sidebar-nav .nav-link { color: #adb5bd; text-decoration: none; padding: 0.75rem 1rem; border-radius: 0.375rem; display: flex; align-items: center; transition: all 0.3s ease; }
        .sidebar-nav .nav-link:hover { color: #fff; background-color: #495057; }
        .sidebar-nav .nav-link.active { color: #fff; background-color: #0d6efd; }
        .sidebar-nav .nav-link i { margin-right: 0.5rem; width: 20px; }
        .main-content { margin-left: 280px; padding: 2rem; min-height: 100vh; }
        .sidebar-toggle { display: none; position: fixed; top: 1rem; left: 1rem; z-index: 1001; background-color: #343a40; color: #fff; border: none; padding: 0.5rem; border-radius: 0.375rem; }
        @media (max-width: 768px) { .sidebar { transform: translateX(-100%); } .sidebar.show { transform: translateX(0); } .main-content { margin-left: 0; padding-top: 4rem; } .sidebar-toggle { display: block; } }
        .page-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 0.5rem; margin-bottom: 2rem; }
    </style>
</head>
<body>
    <nav class="sidebar" id="sidebar">
        <a href="#" class="sidebar-brand">
            <i class="fas fa-chart-line me-2"></i>
            Kraken Paper Trading Bot
        </a>
        <ul class="sidebar-nav">
            <li class="nav-item"><a class="nav-link" href="/"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="/pairs"><i class="fas fa-coins"></i> Pairs & Charts</a></li>
            <li class="nav-item"><a class="nav-link active" href="/bot"><i class="fas fa-robot"></i> Bot</a></li>
            <li class="nav-item"><a class="nav-link" href="/history"><i class="fas fa-history"></i> Trading History</a></li>
            <li class="nav-item"><a class="nav-link" href="/price-data"><i class="fas fa-database"></i> Price Data</a></li>
            <li class="nav-item"><a class="nav-link" href="/settings"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
        <div class="position-absolute bottom-0 start-0 end-0 p-3">
            <small class="text-muted d-block mb-1">Connection</small>
            <span class="badge bg-warning w-100 text-start" id="connectionStatus">
                <i class="fas fa-circle"></i> Connecting...
            </span>
        </div>
    </nav>

    <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-bars"></i></button>

    <div class="main-content">
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2"><i class="fas fa-robot me-2"></i>Bot Control</h1>
                    <p class="mb-0 opacity-75">Select a strategy, configure parameters, and start the bot</p>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <span id="botStatus" class="badge bg-warning">Stopped</span>
                    <button class="btn btn-sm btn-danger" id="closeAllBtn" title="Close all open positions" disabled>
                        <i class="fas fa-times-circle me-1"></i>Close All Positions
                    </button>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Strategy Selection</h6>
            </div>
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label for="strategySelect" class="form-label">Strategy</label>
                        <select id="strategySelect" class="form-select"></select>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-secondary" id="stopBotBtn" disabled>
                            <i class="fas fa-stop me-2"></i>Stop Bot
                        </button>
                        <button class="btn btn-primary" id="startBotBtn" disabled>
                            <i class="fas fa-play me-2"></i>Start Bot
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-wrench me-2"></i>Parameters</h6>
            </div>
            <div class="card-body" id="paramsContainer">
                <div class="text-muted">Select a strategy to configure its parameters.</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/connection.js"></script>
    <script>
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        if (sidebarToggle && sidebar) {
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('show');
            });
            document.addEventListener('click', function(event) {
                if (window.innerWidth <= 768) {
                    if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target)) {
                        sidebar.classList.remove('show');
                    }
                }
            });
        }

        const state = { strategies: [], selected: null };

        async function loadStrategies() {
            const res = await fetch('/api/strategies');
            const json = await res.json();
            if (!json.success) return;
            state.strategies = json.data;
            const sel = document.getElementById('strategySelect');
            sel.innerHTML = '<option value="">Select strategy...</option>' +
                state.strategies.map(s => `<option value="${s.key}">${s.name}</option>`).join('');
        }

        function renderParams(strat) {
            const container = document.getElementById('paramsContainer');
            if (!strat) { container.innerHTML = '<div class="text-muted">Select a strategy to configure its parameters.</div>'; return; }
            const fields = Object.entries(strat.params).map(([key, def]) => {
                if (def.type === 'select') {
                    return `<div class="col-md-4"><label class="form-label">${def.label}</label>
                        <select class="form-select" data-key="${key}">
                            ${def.options.map(o => `<option value="${o}" ${o===def.default?'selected':''}>${o}</option>`).join('')}
                        </select></div>`;
                }
                const step = def.step ? ` step="${def.step}"` : '';
                const min = def.min != null ? ` min="${def.min}"` : '';
                const max = def.max != null ? ` max="${def.max}"` : '';
                return `<div class="col-md-4"><label class="form-label">${def.label}</label>
                    <input type="number" class="form-control" data-key="${key}" value="${def.default}"${step}${min}${max}></div>`;
            }).join('');
            container.innerHTML = `<div class="row g-3">${fields}</div>`;
        }

        function collectParams() {
            const params = {};
            document.querySelectorAll('#paramsContainer [data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                params[key] = el.tagName === 'SELECT' ? el.value : Number(el.value);
            });
            return params;
        }

        function setBotStatus(running, strategy) {
            const badge = document.getElementById('botStatus');
            if (running) { badge.className = 'badge bg-success'; badge.textContent = `Running${strategy? ' - ' + strategy : ''}`; }
            else { badge.className = 'badge bg-warning'; badge.textContent = 'Stopped'; }
            document.getElementById('startBotBtn').disabled = running || !state.selected;
            document.getElementById('stopBotBtn').disabled = !running;
        }

        document.getElementById('strategySelect').addEventListener('change', (e) => {
            const key = e.target.value;
            state.selected = state.strategies.find(s => s.key === key) || null;
            renderParams(state.selected);
            document.getElementById('startBotBtn').disabled = !state.selected;
        });

        document.getElementById('startBotBtn').addEventListener('click', async () => {
            if (!state.selected) return;
            const params = collectParams();
            const res = await fetch('/api/start-bot', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ strategy: state.selected.key, params }) });
            const json = await res.json();
            if (json.success) setBotStatus(true, json.strategy);
            else alert(json.error || 'Failed to start bot');
        });

        document.getElementById('stopBotBtn').addEventListener('click', async () => {
            const res = await fetch('/api/stop-bot', { method: 'POST' });
            const json = await res.json();
            if (json.success) setBotStatus(false);
            else alert(json.error || 'Failed to stop bot');
        });

        // Close all open positions
        document.getElementById('closeAllBtn').addEventListener('click', async () => {
            if (!confirm('Close ALL open positions now?')) return;
            const btn = document.getElementById('closeAllBtn');
            const prev = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Closing...';
            try {
                const response = await fetch('/api/close-all-positions', { method: 'POST' });
                const data = await response.json();
                if (!data.success) alert(data.error || 'Failed to close positions');
            } catch (e) {
                alert('Error closing positions');
            } finally {
                btn.innerHTML = prev; btn.disabled = false;
            }
        });

        window.addEventListener('ws:update', (e) => {
            const d = e.detail;
            setBotStatus(!!d.is_trading, d.strategy);
            // Enable close-all only if there are open positions (if provided) or bot is running
            const hasOpen = typeof d.open_trades === 'number' ? d.open_trades > 0 : !!d.is_trading;
            document.getElementById('closeAllBtn').disabled = !hasOpen;
        });

        loadStrategies();
        // Ensure badge paints on load
        if (window.GlobalConnection) setTimeout(() => window.GlobalConnection.updateStatusBadge(), 0);
    </script>
</body>
</html>
